{% extends "base.html" %}

{% block title %}{{ _("Process Article") }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ _("Content Preparation") }}: <input type="text" class="form-control d-inline-block w-75" id="article-title" value="{{ article.title }}"></h1>
    <p class="mb-3"><a href="{{ article.source_url }}" target="_blank">{{ _("View Original Article") }}</a></p>

    <div class="row">
        <!-- Left Column: Content Structuring -->
        <div class="col-md-6">
            <div class="mb-3">
                <label for="article-type" class="form-label">{{ _("Article Type") }}</label>
                <select class="form-select" id="article-type">
                    <option selected>{{ _("Select Article Type") }}</option>
                    <option value="News">{{ _("News") }}</option>
                    <option value="Research">{{ _("Research") }}</option>
                    <option value="Analysis">{{ _("Analysis") }}</option>
                    <option value="How-to">{{ _("How-to") }}</option>
                </select>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mt-4 mb-3">{{ _("Content Structuring") }}</h2>
                <div class="btn-group mb-3" role="group" id="lang-toggle-group">
                    <button type="button" class="btn btn-primary lang-toggle" data-lang="en">English</button>
                    <button type="button" class="btn btn-outline-secondary lang-toggle" data-lang="te">Telugu</button>
                </div>
            </div>
            <div id="content-structuring-sections"></div>

            <button class="btn btn-primary" id="save-content-structuring-btn">{{ _("Save Content Structuring") }}</button>
        </div>

        <!-- Right Column: Final Article Details -->
        <div class="col-md-6">
            <h2 class="mt-4 mb-3">{{ _("Final Article Details") }}</h2>

            <div class="mb-3">
                <label for="final-title-en" class="form-label">{{ _("Title (English)") }}</label>
                <textarea class="form-control" id="final-title-en" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label for="final-summary-en" class="form-label">{{ _("Summary (English)") }}</label>
                <textarea class="form-control" id="final-summary-en" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="final-content-en" class="form-label">{{ _("Content (English)") }}</label>
                <textarea class="form-control" id="final-content-en" rows="10"></textarea>
            </div>

            <div class="mb-3">
                <label for="final-title-te" class="form-label">{{ _("Title (Telugu)") }}</label>
                <textarea class="form-control" id="final-title-te" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label for="final-summary-te" class="form-label">{{ _("Summary (Telugu)") }}</label>
                <textarea class="form-control" id="final-summary-te" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="final-content-te" class="form-label">{{ _("Content (Telugu)") }}</label>
                <textarea class="form-control" id="final-content-te" rows="10"></textarea>
            </div>

            <div class="mb-3">
                <label for="image-url" class="form-label">{{ _("Image URL") }}</label>
                <input type="text" class="form-control" id="image-url" value="{{ article.image_url or '' }}">
            </div>
            <div class="mb-3">
                <label for="source-name" class="form-label">{{ _("Source Name") }}</label>
                <input type="text" class="form-control" id="source-name" value="{{ article.source_name }}" readonly>
            </div>
            <div class="mb-3">
                <label for="category" class="form-label">{{ _("Category") }}</label>
                <input type="text" class="form-control" id="category" value="{{ article.category }}" readonly>
            </div>
            <div class="mb-3">
                <label for="published-date" class="form-label">{{ _("Published Date") }}</label>
                <input type="text" class="form-control" id="published-date" value="{{ article.published_date.strftime('%Y-%m-%d %H:%M') if article.published_date else '' }}" readonly>
            </div>
            <div class="mb-3">
                <label for="content-type" class="form-label">{{ _("Content Type") }}</label>
                <input type="text" class="form-control" id="content-type" value="{{ article.content_type or '' }}" readonly>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-secondary" id="prepare-final-content-btn">{{ _("Prepare Final Content") }}</button>
                <button class="btn btn-success" id="publish-final-article-btn">{{ _("Publish Final Article") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const articleTypeSelect = document.getElementById('article-type');
        const contentStructuringSectionsDiv = document.getElementById('content-structuring-sections');
        const saveContentStructuringBtn = document.getElementById('save-content-structuring-btn');
        const langToggleGroup = document.getElementById('lang-toggle-group');

        const prepareFinalContentBtn = document.getElementById('prepare-final-content-btn');
        const publishFinalArticleBtn = document.getElementById('publish-final-article-btn');

        const finalTitleEn = document.getElementById('final-title-en');
        const finalSummaryEn = document.getElementById('final-summary-en');
        const finalContentEn = document.getElementById('final-content-en');
        const finalTitleTe = document.getElementById('final-title-te');
        const finalSummaryTe = document.getElementById('final-summary-te');
        const finalContentTe = document.getElementById('final-content-te');
        const imageUrl = document.getElementById('image-url');

        let currentLang = 'en';
        let structuredData = {}; // To store the full bilingual data

        // --- Language Toggle Logic ---
        langToggleGroup.addEventListener('click', (e) => {
            if (e.target.classList.contains('lang-toggle')) {
                currentLang = e.target.dataset.lang;
                updateLanguageView();
            }
        });

        function updateLanguageView() {
            document.querySelectorAll('.lang-toggle').forEach(btn => {
                if (btn.dataset.lang === currentLang) {
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-outline-secondary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-secondary');
                }
            });

            document.querySelectorAll('.lang-content-wrapper').forEach(wrapper => {
                if (wrapper.dataset.lang === currentLang) {
                    wrapper.style.display = 'block';
                } else {
                    wrapper.style.display = 'none';
                }
            });
        }

        // --- AI Content Structuring ---
        articleTypeSelect.addEventListener('change', async function() {
            const selectedType = this.value;
            const articleId = {{ article.id }};

            if (selectedType === "Select Article Type") {
                contentStructuringSectionsDiv.innerHTML = '';
                return;
            }

            contentStructuringSectionsDiv.innerHTML = '<p>Generating content structuring using AI...</p>';

            try {
                const response = await fetch(`/api/raw_articles/${articleId}/structure_content_ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article_type: selectedType })
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    structuredData = result.structured_sections;
                    renderStructuredContent();
                    updateLanguageView();
                } else {
                    contentStructuringSectionsDiv.innerHTML = `<p class="text-danger">Failed to generate content structuring: ${result.detail || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Error during AI content structuring:', error);
                contentStructuringSectionsDiv.innerHTML = '<p class="text-danger">An error occurred during AI content structuring.</p>';
            }
        });

        function renderStructuredContent() {
            contentStructuringSectionsDiv.innerHTML = ''; // Clear loading message

            for (const sectionTitle in structuredData) {
                const sectionData = structuredData[sectionTitle];
                const sectionWrapper = document.createElement('div');
                sectionWrapper.classList.add('mb-4', 'section-container');
                sectionWrapper.dataset.sectionTitle = sectionTitle;

                const titleElement = document.createElement('h5');
                titleElement.textContent = sectionTitle;
                sectionWrapper.appendChild(titleElement);

                // English version
                const enWrapper = document.createElement('div');
                enWrapper.classList.add('lang-content-wrapper');
                enWrapper.dataset.lang = 'en';
                const enTextArea = document.createElement('textarea');
                enTextArea.classList.add('form-control', 'lang-en-content');
                enTextArea.rows = 5;
                enTextArea.value = sectionData.en || '';
                enWrapper.appendChild(enTextArea);
                sectionWrapper.appendChild(enWrapper);

                // Telugu version
                const teWrapper = document.createElement('div');
                teWrapper.classList.add('lang-content-wrapper');
                teWrapper.dataset.lang = 'te';
                const teTextArea = document.createElement('textarea');
                teTextArea.classList.add('form-control', 'lang-te-content');
                teTextArea.rows = 5;
                teTextArea.value = sectionData.te || '';
                teWrapper.appendChild(teTextArea);
                sectionWrapper.appendChild(teWrapper);

                contentStructuringSectionsDiv.appendChild(sectionWrapper);
            }
        }

        // --- Save Content Structuring ---
        saveContentStructuringBtn.addEventListener('click', async () => {
            const articleId = {{ article.id }};
            const articleTitle = document.getElementById('article-title').value;
            const articleType = document.getElementById('article-type').value;

            if (!articleTitle || articleType === "Select Article Type") {
                alert('Please provide an article title and select an article type.');
                return;
            }

            // Collect data from all textareas
            const updatedSections = {};
            document.querySelectorAll('.section-container').forEach(container => {
                const title = container.dataset.sectionTitle;
                const enContent = container.querySelector('.lang-en-content').value;
                const teContent = container.querySelector('.lang-te-content').value;
                updatedSections[title] = {
                    en: enContent,
                    te: teContent
                };
            });

            console.log('Saving data:', updatedSections);

            try {
                saveContentStructuringBtn.textContent = 'Saving...';
                saveContentStructuringBtn.disabled = true;

                const response = await fetch(`/api/raw_articles/${articleId}/save_structured_content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_title: articleTitle,
                        article_type: articleType,
                        sections: updatedSections
                    })
                });

                if (response.ok) {
                    saveContentStructuringBtn.textContent = 'Saved!';
                    setTimeout(() => {
                        saveContentStructuringBtn.textContent = 'Save Content Structuring';
                        saveContentStructuringBtn.disabled = false;
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    alert(`Failed to save content structuring: ${errorData.detail || 'Unknown error'}`);
                    saveContentStructuringBtn.textContent = 'Save Content Structuring';
                    saveContentStructuringBtn.disabled = false;
                }
            }
            catch (error) {
                console.error('Error saving content structuring:', error);
                alert('An error occurred while saving content structuring.');
                saveContentStructuringBtn.textContent = 'Save Content Structuring';
                saveContentStructuringBtn.disabled = false;
            }
        });

        // --- Prepare Final Content ---
        prepareFinalContentBtn.addEventListener('click', () => {
            // Combine structured sections into final content textareas
            let combinedEnContent = '';
            let combinedTeContent = '';
            let firstEnSummary = '';
            let firstTeSummary = '';

            for (const sectionTitle in structuredData) {
                const section = structuredData[sectionTitle];
                const enText = section.en || '';
                const teText = section.te || '';

                // For content, combine all sections
                combinedEnContent += `## ${sectionTitle}\n\n${enText}\n\n`;
                combinedTeContent += `## ${sectionTitle}_te\n\n${teText}\n\n`; // Placeholder for translated title

                // For summary, take the first significant section or overall summary
                if (!firstEnSummary && enText.length > 50) {
                    firstEnSummary = enText.substring(0, 200) + '...'; // Take first 200 chars as summary
                }
                if (!firstTeSummary && teText.length > 50) {
                    firstTeSummary = teText.substring(0, 200) + '...'; // Take first 200 chars as summary
                }
            }

            finalTitleEn.value = document.getElementById('article-title').value;
            finalContentEn.value = combinedEnContent.trim();
            finalSummaryEn.value = firstEnSummary || finalContentEn.value.substring(0, 200) + '...';

            finalTitleTe.value = document.getElementById('article-title').value + '_te'; // Placeholder
            finalContentTe.value = combinedTeContent.trim();
            finalSummaryTe.value = firstTeSummary || finalContentTe.value.substring(0, 200) + '...';
        });

        // --- Publish Final Article ---
        publishFinalArticleBtn.addEventListener('click', async () => {
            const articleId = {{ article.id }};

            const finalArticleData = {
                title_en: finalTitleEn.value,
                summary_en: finalSummaryEn.value,
                content_en: finalContentEn.value,
                title_te: finalTitleTe.value,
                summary_te: finalSummaryTe.value,
                content_te: finalContentTe.value,
                image_url: imageUrl.value,
                source_url: "{{ article.source_url }}",
                source_name: "{{ article.source_name }}",
                category: "{{ article.category }}",
                published_date: "{{ article.published_date.isoformat() if article.published_date else '' }}",
                content_type: "{{ article.content_type or '' }}"
            };

            // Basic validation
            if (!finalArticleData.title_en || !finalArticleData.content_en) {
                alert('English title and content are required to publish.');
                return;
            }

            try {
                publishFinalArticleBtn.textContent = 'Publishing...';
                publishFinalArticleBtn.disabled = true;

                const response = await fetch(`/api/raw_articles/${articleId}/publish_final`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalArticleData)
                });

                if (response.ok) {
                    alert('Article published successfully!');
                    window.location.href = '/curation'; // Redirect back to curation list
                } else {
                    const errorData = await response.json();
                    alert(`Failed to publish article: ${errorData.detail || 'Unknown error'}`);
                    publishFinalArticleBtn.textContent = 'Publish Final Article';
                    publishFinalArticleBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error publishing article:', error);
                alert('An error occurred while publishing the article.');
                publishFinalArticleBtn.textContent = 'Publish Final Article';
                publishFinalArticleBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}