{% extends "base.html" %}

{% block title %}{{ _("Process Article") }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ _("Content Preparation") }}: <input type="text" class="form-control d-inline-block w-75" id="article-title" value="{{ article.title }}"></h1>
    <p class="mb-3"><a href="{{ article.source_url }}" target="_blank">{{ _("View Original Article") }}</a></p>

    <div class="row">
        <div class="col-md-8">
            <div class="mb-3">
                <label for="article-type" class="form-label">{{ _("Article Type") }}</label>
                <select class="form-select" id="article-type">
                    <option selected>{{ _("Select Article Type") }}</option>
                    <option value="News">{{ _("News") }}</option>
                    <option value="Research">{{ _("Research") }}</option>
                    <option value="Analysis">{{ _("Analysis") }}</option>
                    <option value="How-to">{{ _("How-to") }}</option>
                </select>
            </div>

            <div id="content-structuring-sections"></div>

            <button class="btn btn-primary" id="save-content-structuring-btn">{{ _("Save Content Structuring") }}</button>
            <button class="btn btn-info" id="edit-content-structuring-btn">{{ _("Edit Content Structuring") }}</button>
        </div>
        <div class="col-md-4">
            <h2>{{ _("Curation Actions") }}</h2>
            <div class="d-grid gap-2">
                <button class="btn btn-secondary" id="prepare-content-btn">{{ _("Prepare Content") }}</button>
                <button class="btn btn-success" id="approve-btn">{{ _("Approve") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const articleTypeSelect = document.getElementById('article-type');
        const contentStructuringSectionsDiv = document.getElementById('content-structuring-sections');

        const sections = {
            "News": [
                "What is this about?",
                "Any change to existing feature/item?",
                "Brief background of the news.",
                "When is it expected to come?",
                "What value it might add?",
                "Competitor advantage."
            ],
            "Research": [
                "What is the research about?",
                "What are the key findings?",
                "What are the implications of the research?",
                "What are the limitations of the research?"
            ],
            "Analysis": [
                "What is being analyzed?",
                "What are the main points of the analysis?",
                "What are the conclusions of the analysis?",
                "What are the recommendations?"
            ],
            "How-to": [
                "What is the goal of this how-to?",
                "What are the prerequisites?",
                "What are the steps involved?",
                "What is the expected outcome?"
            ]
        };

        const saveContentStructuringBtn = document.getElementById('save-content-structuring-btn');
        const editContentStructuringBtn = document.getElementById('edit-content-structuring-btn');

        // Initial state: text areas are editable, save button is visible, edit button is hidden
        let isEditing = true; // Start in editing mode
        editContentStructuringBtn.style.display = 'none'; // Hide edit button initially

        function setContentStructuringEditability(editable) {
            contentStructuringSectionsDiv.querySelectorAll('textarea').forEach(textArea => {
                textArea.readOnly = !editable;
            });
            saveContentStructuringBtn.style.display = editable ? 'block' : 'none';
            editContentStructuringBtn.style.display = editable ? 'none' : 'block';
            isEditing = editable;
        }

        editContentStructuringBtn.addEventListener('click', () => {
            setContentStructuringEditability(true); // Enable editing
        });

        // Call AI content structuring on article type change
        articleTypeSelect.addEventListener('change', async function() {
            const selectedType = this.value;
            const articleId = {{ article.id }};

            if (selectedType === "Select Article Type") {
                contentStructuringSectionsDiv.innerHTML = '';
                setContentStructuringEditability(true); // Keep editable if no type selected
                return;
            }

            contentStructuringSectionsDiv.innerHTML = '<p>Generating content structuring using AI...</p>';
            setContentStructuringEditability(false); // Disable editing during generation

            try {
                const response = await fetch(`/api/raw_articles/${articleId}/structure_content_ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article_type: selectedType })
                });
                const result = await response.json();
                console.log('AI Content Structuring Response:', result);
                console.log('Structured Sections:', result.structured_sections);

                if (response.ok && result.success) {
                    contentStructuringSectionsDiv.innerHTML = ''; // Clear loading message
                    let combinedContent = '';
                    // Populate the text areas with AI-generated content
                    for (const sectionTitle in result.structured_sections) {
                        combinedContent += `## ${sectionTitle}\n\n${result.structured_sections[sectionTitle]}\n\n`;
                    }

                    const singleSectionDiv = document.createElement('div');
                    singleSectionDiv.classList.add('mb-3');

                    const singleTextArea = document.createElement('textarea');
                    singleTextArea.classList.add('form-control');
                    singleTextArea.rows = 20; // Increased rows for better visibility
                    singleTextArea.value = combinedContent.trim();

                    singleSectionDiv.appendChild(singleTextArea);
                    contentStructuringSectionsDiv.appendChild(singleSectionDiv);

                    setContentStructuringEditability(true); // Default to edit mode after generation
                } else {
                    contentStructuringSectionsDiv.innerHTML = `<p class="text-danger">Failed to generate content structuring: ${result.detail || 'Unknown error'}</p>`;
                }
            }
            catch (error) {
                console.error('Error during AI content structuring:', error);
                contentStructuringSectionsDiv.innerHTML = '<p class="text-danger">An error occurred during AI content structuring.</p>';
            }
        });

        // Save Content Structuring functionality
        saveContentStructuringBtn.addEventListener('click', async () => {
            const articleId = {{ article.id }};
            const singleTextArea = contentStructuringSectionsDiv.querySelector('textarea');
            const fullContent = singleTextArea.value;

            const structuredSections = {};
            const lines = fullContent.split('\n');
            let currentSectionTitle = 'Untitled Section';
            let currentSectionContent = [];

            lines.forEach(line => {
                if (line.startsWith('## ')) {
                    // Save previous section if it exists
                    if (currentSectionTitle !== 'Untitled Section' || currentSectionContent.length > 0) {
                        structuredSections[currentSectionTitle.trim()] = currentSectionContent.join('\n').trim();
                    }
                    currentSectionTitle = line.substring(3).trim();
                    currentSectionContent = [];
                } else {
                    currentSectionContent.push(line);
                }
            });
            // Save the last section
            if (currentSectionTitle !== 'Untitled Section' || currentSectionContent.length > 0) {
                structuredSections[currentSectionTitle.trim()] = currentSectionContent.join('\n').trim();
            }

            // If no sections were parsed, treat the whole content as one section
            if (Object.keys(structuredSections).length === 0 && fullContent.trim() !== '') {
                structuredSections['Content Structuring'] = fullContent.trim();
            }

            const articleTitle = document.getElementById('article-title').value;
            const articleType = document.getElementById('article-type').value;

            if (!articleTitle || articleType === "Select Article Type") {
                alert('Please provide an article title and select an article type.');
                saveContentStructuringBtn.disabled = false;
                return;
            }

            console.log('Sending data to backend for saving:');
            console.log('article_title:', articleTitle);
            console.log('article_type:', articleType);
            console.log('sections:', structuredSections);

            try {
                saveContentStructuringBtn.textContent = 'Saving...';
                saveContentStructuringBtn.disabled = true;

                const response = await fetch(`/api/raw_articles/${articleId}/save_structured_content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_title: articleTitle,
                        article_type: articleType,
                        sections: structuredSections
                    })
                });

                if (response.ok) {
                    saveContentStructuringBtn.textContent = 'Saved!';
                    setTimeout(() => {
                        saveContentStructuringBtn.textContent = 'Save Content Structuring';
                        saveContentStructuringBtn.disabled = false;
                        setContentStructuringEditability(false); // Go back to view mode after saving
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    alert(`Failed to save content structuring: ${errorData.detail || 'Unknown error'}`);
                    saveContentStructuringBtn.textContent = 'Save Content Structuring';
                    saveContentStructuringBtn.disabled = false;
                }
            }
            catch (error) {
                console.error('Error saving content structuring:', error);
                alert('An error occurred while saving content structuring.');
                saveContentStructuringBtn.textContent = 'Save Content Structuring';
                saveContentStructuringBtn.disabled = false;
            }
        });

        // Initial setup for existing content (if any, e.g., after page refresh)
        // For now, it just ensures textareas are read-only if they exist
        setContentStructuringEditability(true); // Start in edit mode
    });
</script>
{% endblock %}