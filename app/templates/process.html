{% extends "base.html" %}

{% block title %}{{ _("Process Article") }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ _("Process Article") }}: <input type="text" class="form-control d-inline-block w-75" id="article-title" value="{{ article.title }}"></h1>
    <p class="mb-3"><a href="{{ article.source_url }}" target="_blank">{{ _("View Original Article") }}</a></p>

    <div class="row">
        <div class="col-md-8">
            <div class="mb-3">
                <label for="article-type" class="form-label">{{ _("Article Type") }}</label>
                <select class="form-select" id="article-type">
                    <option selected>{{ _("Select Article Type") }}</option>
                    <option value="News">{{ _("News") }}</option>
                    <option value="Research">{{ _("Research") }}</option>
                    <option value="Analysis">{{ _("Analysis") }}</option>
                    <option value="How-to">{{ _("How-to") }}</option>
                </select>
            </div>

            <div id="dissect-sections"></div>

            <button class="btn btn-primary" id="save-dissect-btn">{{ _("Save Dissection") }}</button>
            <button class="btn btn-info" id="toggle-edit-btn">{{ _("Edit Dissection") }}</button>
        </div>
        <div class="col-md-4">
            <h2>{{ _("Curation Actions") }}</h2>
            <div class="d-grid gap-2">
                <button class="btn btn-secondary" id="rewrite-btn">{{ _("Re-write") }}</button>
                <button class="btn btn-success" id="approve-btn">{{ _("Approve") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const articleTypeSelect = document.getElementById('article-type');
        const dissectSectionsDiv = document.getElementById('dissect-sections');

        const sections = {
            "News": [
                "What is this about?",
                "Any change to existing feature/item?",
                "Brief background of the news.",
                "When is it expected to come?",
                "What value it might add?",
                "Competitor advantage."
            ],
            "Research": [
                "What is the research about?",
                "What are the key findings?",
                "What are the implications of the research?",
                "What are the limitations of the research?"
            ],
            "Analysis": [
                "What is being analyzed?",
                "What are the main points of the analysis?",
                "What are the conclusions of the analysis?",
                "What are the recommendations?"
            ],
            "How-to": [
                "What is the goal of this how-to?",
                "What are the prerequisites?",
                "What are the steps involved?",
                "What is the expected outcome?"
            ]
        };

        const saveDissectBtn = document.getElementById('save-dissect-btn');
        const editDissectBtn = document.getElementById('toggle-edit-btn'); // Renamed for clarity

        // Initial state: text areas are editable, save button is visible, edit button is hidden
        let isEditing = true; // Start in editing mode
        editDissectBtn.style.display = 'none'; // Hide edit button initially

        function setDissectionEditability(editable) {
            dissectSectionsDiv.querySelectorAll('textarea').forEach(textArea => {
                textArea.readOnly = !editable;
            });
            saveDissectBtn.style.display = editable ? 'block' : 'none';
            editDissectBtn.style.display = editable ? 'none' : 'block';
            isEditing = editable;
        }

        editDissectBtn.addEventListener('click', () => {
            setDissectionEditability(true); // Enable editing
        });

        // Call AI dissection on article type change
        articleTypeSelect.addEventListener('change', async function() {
            const selectedType = this.value;
            const articleId = {{ article.id }};

            if (selectedType === "Select Article Type") {
                dissectSectionsDiv.innerHTML = '';
                setDissectionEditability(true); // Keep editable if no type selected
                return;
            }

            dissectSectionsDiv.innerHTML = '<p>Generating dissection using AI...</p>';
            setDissectionEditability(false); // Disable editing during generation

            try {
                const response = await fetch(`/api/raw_articles/${articleId}/dissect_ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article_type: selectedType })
                });
                const result = await response.json();

                if (response.ok && result.success) {
                    dissectSectionsDiv.innerHTML = ''; // Clear loading message
                    // Populate the text areas with AI-generated content
                    for (const sectionTitle in result.dissected_sections) {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.classList.add('mb-3');

                        const label = document.createElement('label');
                        label.classList.add('form-label');
                        label.textContent = sectionTitle;

                        const textArea = document.createElement('textarea');
                        textArea.classList.add('form-control');
                        textArea.rows = 5; // Increased rows for better visibility
                        textArea.value = result.dissected_sections[sectionTitle];

                        sectionDiv.appendChild(label);
                        sectionDiv.appendChild(textArea);

                        dissectSectionsDiv.appendChild(sectionDiv);
                    }
                    setDissectionEditability(true); // Default to edit mode after generation
                } else {
                    dissectSectionsDiv.innerHTML = `<p class="text-danger">Failed to generate dissection: ${result.detail || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Error during AI dissection:', error);
                dissectSectionsDiv.innerHTML = '<p class="text-danger">An error occurred during AI dissection.</p>';
            }
        });

        // Save Dissection functionality
        saveDissectBtn.addEventListener('click', async () => {
            const articleId = {{ article.id }};
            const dissectedSections = {};
            dissectSectionsDiv.querySelectorAll('.mb-3').forEach(sectionDiv => {
                const label = sectionDiv.querySelector('label').textContent;
                const textArea = sectionDiv.querySelector('textarea').value;
                dissectedSections[label] = textArea;
            });

            const articleTitle = document.getElementById('article-title').value;
            const articleType = document.getElementById('article-type').value;

            if (!articleTitle || articleType === "Select Article Type") {
                alert('Please provide an article title and select an article type.');
                saveDissectBtn.disabled = false;
                return;
            }

            try {
                saveDissectBtn.textContent = 'Saving...';
                saveDissectBtn.disabled = true;

                const response = await fetch(`/api/raw_articles/${articleId}/save_dissection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        article_title: articleTitle,
                        article_type: articleType,
                        sections: dissectedSections
                    })
                });

                if (response.ok) {
                    saveDissectBtn.textContent = 'Saved!';
                    setTimeout(() => {
                        saveDissectBtn.textContent = 'Save Dissection';
                        saveDissectBtn.disabled = false;
                        setDissectionEditability(false); // Go back to view mode after saving
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    alert(`Failed to save dissection: ${errorData.detail || 'Unknown error'}`);
                    saveDissectBtn.textContent = 'Save Dissection';
                    saveDissectBtn.disabled = false;
                }
            }
            catch (error) {
                console.error('Error saving dissection:', error);
                alert('An error occurred while saving dissection.');
                saveDissectBtn.textContent = 'Save Dissection';
                saveDissectBtn.disabled = false;
            }
        });

        // Initial setup for existing content (if any, e.g., after page refresh)
        // This part needs to be refined if we want to load saved dissection on page load
        // For now, it just ensures textareas are read-only if they exist
        setDissectionEditability(true); // Start in edit mode
    });
</script>
{% endblock %}